# Docker简介

现在的团队必须快速发布应用，以吸引和留住客户。 由于存在这种要求，软件开发和支持团队必须始终考虑可节省时间和成本的解决方案。 理想的解决方案将减少创建和配置部署环境所花费的时间，并简化软件部署过程。

普遍认为可以将软件容器化技术用作节省时间和降低成本的解决方案。 容器化的一项优势是，无需配置硬件和花费时间安装操作系统和软件来托管部署。 容器之间彼此隔离，并且多个容器可以在相同硬件上运行。 此配置可帮助我们更加高效地使用硬件，并且可以帮助提升应用程序的安全性。

假设你就职于一家在线服装零售公司，你们公司计划开发一些内部应用。 你的团队在本地开发和测试所有应用程序，然后将其部署到 Azure 进行预生产测试和最终生产托管。 你希望在进行很少配置更改或不进行任何配置更改的情况下在每个环境中实现最大兼容性。 使用 Docker 作为容器化解决方案似乎是理想的选择。

在这里，你将了解如何使用 Docker 创建自己的容器。 你还将大致了解 Docker 基础结构的幕后工作原理。 目标是帮助你确定 Docker 容器是否适合你的业务。

## 学习目标

通过学习本模块，你将能够：

* 评估 Docker 是否为合适的容器化平台
* 介绍 Docker 容器的组件如何支持计算容器实现

## 先决条件

* 操作系统虚拟化概念的基础知识
* 基于命令行的应用程序的基础知识

# 什么是 Docker？

在开始 Docker 容器快速导览之前，先了解我们的团队如何开发和部署应用程序。 我们还将简要介绍团队所面临的一些挑战。

在公司开发和管理应用程序的过程中，通常涉及一个或多个团队。 开发团队创建软件，运营团队负责部署这些应用程序。 此外，运营团队还负责管理应用程序托管基础结构。

例如，假设我们要开发一个订单跟踪门户，供公司的各个专卖店使用。 在应用的开发和发布过程中，将由多个环境托管我们的应用程序。 首先，开发团队在开发环境中开发和测试软件。 然后，会将该软件部署到质量保证 (QA) 环境、预生产环境和最终生产环境。

在上述方案中，我们需要考虑几项挑战：

* **托管环境的管理**
  这些不同的环境都需要软件和硬件管理。 必须确保每个环境中已安装的软件和已配置的硬件相同。 此外，还需要以一致且易于复制的方式配置每个环境的网络访问、数据存储和安全性等方面。
* **软件交付的连续性**
  将应用程序部署到环境的过程必须始终一致。 每个部署包都必须包含所有系统包、二进制文件、库、配置文件以及将确保应用程序功能完备的其他项。 此外，还需要确保所有这些依赖项都与软件版本和体系结构相匹配。
* **硬件的高效使用**
  每个已部署应用程序都必须通过与在同一硬件上运行的其他应用程序隔离的方式运行。 我们的目标是在每个服务器上运行多个应用程序以充分利用资源，并使这些应用程序不会相互影响。
* **应用程序可移植性**
  应用程序可移植性不可或缺，有多种原因。 托管环境可能出现故障，或者我们可能需要横向扩展应用程序。 在这两种情况下，可能都需要将软件重新部署到新环境。 我们想要将软件从一个主机移动到另一个主机，即使底层基础结构不同。 此类移动需要尽量快速地完成，以便为客户减少停机时间。

在查看有助于解决这些挑战的 Docker 功能之前，我们将讨论几个概念，并大致了解 Docker 体系结构。

## 什么是容器？

容器是一种松散隔离的环境，可用于生成和运行软件包。 这些软件包包括在任何计算环境中快速可靠地运行应用程序所需的代码和所有依赖项。 我们将这些包称为容器映像。

容器映像是我们用于分发应用程序的单位。

## 什么是软件容器化？

软件容器化是一种操作系统虚拟化方法，用于在不使用虚拟机 (VM) 的情况下部署和运行容器。 容器可在物理硬件上、云和 VM 中运行，还可以在多个操作系统上运行。

## 什么是 Docker？

Docker 是一个用于开发、交付和运行容器的容器化平台。 Docker 不使用虚拟机监控程序，如果要开发和测试应用程序，可以在台式机或笔记本电脑上运行 Docker。 桌面版 Docker 支持 Linux、Windows 和 macOS。 对于生产系统，Docker 适用于服务器环境，包括 Linux 的多种变体和 Microsoft Windows Server 2016 及更高版本。 许多云（包括 Azure）都支持 Docker。

## Docker 体系结构

Docker 平台包含多个用于生成、运行和管理容器化应用程序的组件。

### Docker 引擎

Docker 引擎包含配置为客户端-服务器实现的多个组件，其中，客户端和服务器在同一主机上同时运行。 客户端使用 REST API 与服务器通信，该 API 还让客户端能够与远程服务器实例通信。

![显示 Docker 体系结构的大致概述的关系图。](https://learn.microsoft.com/zh-cn/training/modules/intro-to-docker-containers/media/2-docker-architecture.svg)

而另一些箭头显示了 Docker Server、正在运行的容器和存储的容器映像之间的通信。 这些箭头指出 Docker Server 如何加载存储的容器映像以及管理正在运行的容器。

**Docker 客户端**

Docker 客户端是一个名为 `docker` 的命令行应用程序，它为我们提供了一个命令行接口 (CLI)，用于与 Docker 服务器进行交互。 `docker` 命令使用 Docker REST API 将指令发送到本地或远程服务器，并作为用于管理容器的主要接口。

**Docker 服务器**

Docker 服务器是一个名为 `dockerd` 的守护程序。 `dockerd` 守护程序通过 Docker REST API 响应来自客户端的请求，并且可以与其他守护程序进行交互。 此外，Docker 服务器还负责跟踪容器的生命周期。

**Docker 对象**

你将创建并配置多个对象以支持容器部署。 这些对象包括网络、存储卷、插件和其他服务对象。 我们不会在这里介绍所有这些对象，但请记住，我们可以根据需要创建和部署这些对象。

### Docker Hub

Docker Hub 是一个软件即服务 (SaaS) Docker 容器注册表。 Docker 注册表是用于存储和分发创建的容器映像的存储库。 Docker Hub 是 Docker 用于映像管理的默认公共注册表。

请记住，可以创建和使用专用 Docker 注册表，也可以使用可用的多个云提供商选项之一。 例如，可以使用 Azure 容器注册表来存储容器映像，以便在多个启用了 Azure 容器的服务中使用。

# Docker 容器的工作原理

回想一下，你发现容器是用于分发应用的单位。 你还了解到容器采用开发者团队和运营团队使用的标准化格式。

在示例中，你要开发一个订单跟踪门户，供公司的各个专卖店使用。 生成 Docker 映像后，现在由运营团队负责订单跟踪门户的部署、更新推出和管理。

在之前的单元中，你了解了如何生成 Docker 映像。 在这里，你将简单了解下 Docker 容器的生命周期以及如何管理容器。 你还将了解如何考虑为容器配置数据存储和网络选项。

## 如何管理 Docker 容器

Docker 容器具有可用于管理和跟踪容器状态的生命周期。

![显示容器生命周期以及生命周期阶段之前的过渡的关系图。](https://learn.microsoft.com/zh-cn/training/modules/intro-to-docker-containers/media/4-docker-container-lifecycle-2.png)

若要将容器置于运行状态，请使用 run 命令。 还可重启已在运行的容器。 重启容器时，容器将收到一个 termination 信号，以允许任何正在运行的进程在容器的内核终止之前正常关闭。

容器在暂停、停止或终止之前将被视为处于运行状态。 但是，容器也可能会自行退出运行状态。 当正在运行的进程完成或者进程进入错误状态时，容器可自行退出。

若要暂停正在运行的容器，请使用 pause 命令。 此命令会暂停容器中的所有进程。

若要停止正在运行的容器，请使用 stop 命令。 Stop 命令通过向正在运行的进程发送 termination 信号来正常关闭该进程。 进程关闭后，容器的内核将终止。

如果需要终止容器，请使用 kill 命令发送 kill 信号。 正在运行的进程不会捕获 kill 信号，而仅捕获容器的内核。 此命令将强制终止容器中正在运行的进程。

最后，若要删除处于停止状态的容器，请使用 remove 命令。 删除容器后，将销毁存储在容器中的所有数据。

## 如何查看可用容器

若要列出正在运行的容器，请使用 `docker ps` 命令。 若要查看处于所有状态的所有容器，请传递 `-a` 参数。

下面是一个示例。

**控制台**

```
docker ps -a
```

该命令的输出如下所示。

**输出**

```
CONTAINER ID    IMAGE        COMMAND         CREATED       STATUS           PORTS        NAMES
d93d40cc1ce9    tmp-ubuntu:latest  "dotnet website.dll …"  6 seconds ago    Up 5 seconds        8080/tcp      happy_wilbur
33a6cf71f7c1    tmp-ubuntu:latest  "dotnet website.dll …"  2 hours ago     Exited (0) 9 seconds ago            adoring_borg
```

需要查看以上输出中的以下三个项：

* “IMAGE”列中列出的映像名称。 在本例中，该名称为 tmp-ubuntu: latest。 请注意，你可以从同一映像创建多个容器。 此功能是一种强大的管理功能，用于在解决方案中实现缩放。
* “STATUS”列中列出的容器状态。 在本例中，一个容器正在运行，一个容器已退出。 容器的状态通常是容器运行状况的第一个指标。
* “NAMES”列中列出的容器名称。 除了第一列中的容器 ID 之外，容器还将接收名称。 在本例中，由于你没有为每个容器显式提供名称，因此，Docker 为容器提供了随机名称。 若要使用 `--name` 标志为容器提供显式名称，请使用 run 命令。

### 为什么要为容器命名？

借助此功能，可运行同一映像的多个容器实例。 容器名称是唯一的，这意味着，如果指定了某一名称，则不能重复使用该名称来创建新的容器。 重复使用特定名称的唯一方法是删除之前的容器。

## 如何运行容器

若要启动容器，请运行 `docker run` 命令。 只需按名称或 ID 指定要运行的映像，即可从映像启动容器。 通过此方式启动的容器提供交互式体验。

此处，若要在网站处于后台的情况下运行容器，请添加 `-d` 标志。

**控制台**复制

```
docker run -d tmp-ubuntu
```

在此示例中，该命令仅返回新容器的 ID。

指定要运行的映像后，Docker 将查找该映像，从该映像加载容器，并执行指定为入口点的命令。 此时，容器可供管理。

## 如何暂停容器

若要暂停容器，请运行 `docker pause` 命令。 下面是一个示例。

**控制台**复制

```
docker pause happy_wilbur
```

暂停容器将暂停所有进程。 通过此命令，容器可在后续阶段继续执行进程。 `docker unpause` 命令将取消挂起指定容器中的所有进程。

### 如何重启容器

若要重启容器，请运行 `docker restart` 命令。 下面是一个示例。

**控制台**

```
docker restart happy_wilbur
```

容器会收到 stop 命令，然后是 start 命令。 如果容器未响应 stop 命令，将发送 kill 信号。

### 如何停止容器

若要停止正在运行的容器，请运行 `docker stop` 命令。 下面是一个示例。

**控制台**

```
docker stop happy_wilbur
```

stop 命令会将 termination 信号发送到容器和容器中正在运行的进程。

### 如何删除容器

若要删除容器，请运行 `docker rm` 命令。 下面是一个示例。

**控制台**复制

```
docker rm happy_wilbur
```

删除容器后，将销毁容器中的所有数据。 考虑存储数据时，始终将容器视为临时容器非常重要。

## Docker 容器存储配置

如前文所述，如果容器中的应用需要存储数据，则始终将容器视为临时容器。

假设我们的跟踪门户在应用根的子文件夹（即直接到容器的文件系统）中创建了一个日志文件。 当应用将数据写入日志文件时，系统会将数据写入可写容器层。

虽然此方法很有效，但遗憾的是，它存在一些缺点。

* 容器存储是临时的
  日志文件不会在容器实例之间存留。 例如，假设你停止并删除容器。 当你启动新容器实例时，新实例将基于指定的映像，而以前的所有数据将丢失。 请记住，删除容器时，将随容器销毁容器中的所有数据。
* 容器存储与底层主机耦合
  容器与底层主机耦合时，很难从容器访问或移动日志文件。 必须连接到容器实例来访问该文件。
* 容器存储驱动程序性能较低
  容器实现存储驱动程序，以允许应用写入数据。 此驱动程序引入额外抽象来与主机操作系统内核通信，比直接写入主机文件系统的性能要低。

容器可以使用两种选项来保持数据。 第一种选项是使用卷，第二种选项则是绑定装载。

### 什么是卷？

卷存储在主机文件系统上的特定文件夹位置。 选择一个文件夹，确保其中的数据只能由 Docker 进程修改。

Docker 通过运行 `docker volume create` 命令创建和管理新卷。 此命令可以构成 Dockerfile 定义的一部分，这意味着你可以在容器创建过程中创建卷。 如果在第一次尝试将卷装载到容器中时，该卷不存在，则 Docker 将创建该卷。

卷存储在主机文件系统上的目录中。 Docker 将装载并管理容器中的卷。 装载后，这些卷将与主机隔离。

多个容器可以同时使用相同的卷。 当容器停止使用卷时，不会自动删除这些卷。

在本例中，你可以在容器主机上创建一个目录，并在创建跟踪门户容器时将此卷装载到容器中。 当跟踪门户记录数据时，你可以通过容器主机的文件系统访问此信息。 即使删除了容器，你仍可以访问此日志文件。

### 什么是绑定装载？

绑定装载在概念上与卷相同，但是，你可以在主机上装载任何文件或文件夹，而不是使用特定文件夹。 你还希望主机可以更改这些装载的内容。 与卷一样，如果你要装载的绑定不存在于主机上，系统将创建该绑定装载。

与卷相比，绑定装载的功能有限，虽然性能更高，但仍依赖于具主机上的特定文件夹结构。

卷是公认的用于容器的首选数据存储策略。

## Docker 容器网络配置

默认 Docker 网络配置允许在 Docker 主机上隔离容器。 借助此功能，可以生成和配置可彼此安全通信的应用。

Docker 提供了三种预配置的网络配置：

* 桥接
* 主机
* 无

根据容器的网络要求选择要向其应用的网络配置。

### 什么是桥接网络？

启动容器而未指定任何其他网络配置时，默认对容器应用桥接网络配置。 此网络是容器使用的内部专用网络，它将容器网络与 Docker 主机网络隔离。

桥接网络中的每个容器都分配有一个 IP 地址和子网掩码，主机名默认为容器名称。 允许连接到默认桥接网络的容器按 IP 地址访问其他通过桥接网络连接的容器。 桥接网络不允许使用主机名在容器之间进行通信。

默认情况下，Docker 不会发布任何容器端口。 若要在容器端口和 Docker 主机端口之间启用端口映射，请使用 Docker 端口 `--publish` 标志。

publish 标志可有效配置映射端口的防火墙规则。

在本例中，浏览到端口 80 的客户端可以访问你的跟踪门户。 必须将端口 80 从容器映射到主机上的可用端口。 你在主机上打开了端口 8080，因此可设置如下标志。

**控制台**

```
--publish 8080:80
```

任何浏览到 Docker 主机 IP 和端口 8080 的客户端都可以访问跟踪门户。

### 什么是主机网络？

通过主机网络，你可以直接在主机网络上运行容器。 此配置在网络级别有效地消除了主机与容器之间的隔离。

在本例中，假设你决定将网络配置更改为主机网络选项。 仍可使用主机 IP 访问跟踪门户。 现在，可以使用已知端口 80，而不是映射的端口。

请记住，容器只能使用主机尚未使用的端口。

### 什么是“无”网络？

若要禁止容器使用网络，请使用“无”网络选项。

### 操作系统注意事项

请记住，各桌面操作系统上的 Docker 网络配置选项存在差异。 例如，使用桥接网络时，Docker0 网络接口在 macOS 上不可用；Windows 和 macOS 桌面版均不支持使用主机网络配置。

这些差异可能会影响开发者配置用于管理容器开发的工作流。

## 知识检查

**1.** 使用 --publish 80:8080 标志启动容器。 以下哪个选项最有可能是为容器配置的网络？

[ ] 无

[ ] 桥接

“桥接”网络配置是容器使用的内部专用网络，它将容器网络与 Docker 主机网络隔离。 我们使用 publish 标志在容器和主机端口之间映射端口。

[ ] 主机

“主机”网络配置允许容器使用主机的 IP 地址和端口。 此网络不使用 publish 标志。

**2.** 以下哪个存储选项是允许主机和容器共享文件以管理名称服务器解析（例如 Linux 上的 resolve.conf 文件）的最佳选择？

[ ] 卷

卷存储在主机文件系统上的特定文件夹位置。 但是，卷数据不应由主机更新。

[ ] 绑定装载

与卷一样，绑定装载也存储在主机文件系统上的特定文件夹位置。 但是，绑定装载数据应由主机更新。 resolve.conf 内容应随主机更改，并由容器和主机使用。

# 何时使用 Docker 容器

我们已经看到，Docker 提供了几项功能供我们使用。 在这里，我们将探讨 Docker 向开发和运营团队提供的好处。 此外，我们还将介绍 Docker 可能并非最佳选择的一些场景。

这些方面将帮助确定 Docker 是否适合你的容器化策略。

回忆一下，之前我们讲到过，我们的团队在开发和发布订单跟踪门户时遇到了许多挑战。 他们正寻求一种解决方案，以便：

* 轻松管理托管环境
* 保证连续交付软件
* 确保高效使用服务器硬件
* 允许实现应用程序可移植性

Docker 便是应对这些挑战的解决方案。 让我们来看一下目前所介绍的所有优点。

## Docker 的优点

使用 Docker 时，可以立即获得容器化所提供的好处。

### 硬件的高效使用

容器可在不使用虚拟机 (VM) 的情况下运行。 正如我们所见，容器依靠主机内核来实现文件系统、网络管理、进程调度和内存管理等功能。

![将 VM 资源使用与 Docker 资源使用进行比较的关系图。](https://learn.microsoft.com/zh-cn/training/modules/intro-to-docker-containers/media/5-efficient-use-hardware.svg)

与 VM 相比，我们发现，VM 需要安装操作系统来为 VM 中正在运行的应用程序提供内核功能。 请记住，VM 操作系统还需要磁盘空间、内存和 CPU 时间。 通过消除 VM 和附加的操作系统要求，可以释放主机上的资源，并将其用于运行其他容器。

### 容器隔离

Docker 容器提供了安全功能，可在同一主机上同时运行多个容器，而不会相互影响。 正如我们所见，我们可以配置数据存储和网络配置，以便隔离容器或在特定容器之间共享数据和连接。

让我们将此功能与使用 VM 进行比较。

![显示正在运行多个 VM 的物理主机的关系图。](https://learn.microsoft.com/zh-cn/training/modules/intro-to-docker-containers/media/5-multiple-app-isolation.svg)

假设我们有一个运行两个 VM 的物理主机。 我们有三个需要彼此独立运行的应用程序。 我们决定将第一个应用部署到 VM 1，将第二个应用部署到 VM 2，以便将这两个应用彼此隔开。 如果我们现在选择安装第三个应用程序，则需要安装另一个 VM 以沿用此模式。

### 应用程序可移植性

容器几乎可在任何地方运行，包括桌面、物理服务器、VM 和云中。 利用此运行时兼容性，可以轻松在不同环境之间移动容器化应用程序。

由于容器是轻型的，因此它们不会像 VM 那样启动或关闭速度缓慢。 因此，可以顺利且快速地重新部署和使用其他部署方案，如扩展或缩减。

### 应用程序交付

借助 Docker，我们可以将容器用作分发应用程序的单位。 这一概念可确保我们具有开发者团队和运营团队使用的标准化容器格式。 开发者可以专注于开发软件，而运营团队可以专注于部署和管理软件。

在开发团队发布应用程序版本后，我们便可以在部署系统的每个步骤中使用容器。 容器非常适合用于持续集成，并且可以加快从生成到生产的时间。

### 托管环境的管理

我们在内部将应用程序的环境配置到容器。 由于这种包含关系，我们的运营团队可以更加密切地灵活管理应用程序的环境。 我们的团队可以监视操作系统更新，应用一次安全修补程序，并根据需要推出更新后的容器。

此外，我们的团队还可以在不影响其他容器的情况下管理要安装、更新和删除的应用程序。 每个容器都是隔离的，并且其资源限制的分配与其他容器是分开的。

### 云部署

Docker 容器是 Azure 容器化服务中使用的默认容器体系结构，在许多其他云平台上均受支持。

例如，可以将 Docker 容器部署到 Azure 容器实例、Azure 应用服务和 Azure Kubernetes 服务。 其中的每个选项都提供了不同的特性与功能。

例如，通过 Azure 容器实例，你可以专注于设计和生成应用程序，没有管理基础结构的开销。 当需要安排多个容器时，可以通过 Azure Kubernetes 服务轻松部署和管理大规模容器部署。

## 何时不使用 Docker 容器

正如我们所见，Docker 容器为我们提供了许多好处。 请记住，容器不一定能满足你的所有需求。 需要注意以下几个方面。

### 安全性和虚拟化

容器提供了一定程度的隔离。 但是，容器共享单个主机操作系统内核，也就是说共享单个攻击点。

此外，我们还需要考虑存储和网络等配置方面的问题，确保我们考虑到了所有安全性方面。 例如，默认情况下，所有容器都将使用桥接网络，并且可以通过 IP 地址相互访问。

并非所有应用程序都将受益于容器化。 在这些情况下，使用 VM 可能更理智。

### 服务监视

管理应用程序和容器比传统的 VM 部署更加复杂。 通过日志记录功能，我们可以了解正在运行的容器的状态。 但是，我们很难监视有关容器中服务的更详细的信息。

例如，Docker 为我们提供了 `docker stats` 命令。 此命令返回有关容器的信息，例如 CPU 使用百分比、内存使用百分比、写入磁盘的 I/O、发送和接收的网络数据以及分配的进程 ID。 此信息作为即时数据流很有用，但是，由于不会存储数据，因此不会进行聚合。 我们必须安装第三方软件，以便在一段时间内捕获有意义的数据。

# 摘要

我们的目标是帮助你评估 Docker 容器是否适合你的业务流程。 我们介绍了 Docker 容器带来的一些优势，还探究了 Docker 不适用的一些情况。

你要寻找这样一种容器化解决方案：只需很少配置或无需配置更改，即可在每个环境中提供最大兼容性。 我们发现，Docker 是一种不错的解决方案，它使我们能够创建应用程序及其所有依赖项的快照。 然后，我们在开发、测试和生产环境中部署这一快照。

最后，Azure 提供了各种部署选项来托管 Docker 容器。 在 Azure 中，容器可与其他 Azure 服务集成，从而拓展产品功能或与其他服务交换数据。
